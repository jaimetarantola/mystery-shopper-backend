<script>
let isRecommendedTemplate = false;

document.getElementById("recommendedToggle").addEventListener("change", function () {
  isRecommendedTemplate = this.checked;
  if (this.checked) {
    document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
  }
});

document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
  cb.addEventListener("change", function () {
    if (isRecommendedTemplate && !this.checked) {
      document.getElementById("recommendedToggle").checked = false;
      isRecommendedTemplate = false;
    }
  });
});

document.querySelectorAll('button.add-btn').forEach(btn => {
  btn.addEventListener("click", function () {
    if (isRecommendedTemplate) {
      document.getElementById("recommendedToggle").checked = false;
      isRecommendedTemplate = false;
    }
  });
});

document.getElementById('shopForm').addEventListener('submit', async function (e) {
  e.preventDefault();

  const sections = document.querySelectorAll('.section');
  const template = {};

  sections.forEach(section => {
    const title = section.querySelector('h3')?.textContent || '';
    const questions = [];

    section.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
      if (cb.nextElementSibling) {
        questions.push(cb.nextElementSibling.textContent.trim());
      }
    });

    section.querySelectorAll('input[name="custom"]').forEach(input => {
      if (input.value.trim()) {
        questions.push("[CUSTOM] " + input.value.trim());
      }
    });

    if (questions.length > 0) {
      template[title] = questions;
    }
  });

  try {
    const res = await fetch('/save-template', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ template, recommended: isRecommendedTemplate })
    });

    const result = await res.json();
    if (res.status === 201) {
      alert(result.message);
      window.location.href = "/dashboard";
    } else {
      alert(result.error || "Unexpected error occurred.");
    }
  } catch (err) {
    console.error("Error:", err);
    alert("Template failed due to server error.");
  }
});
</script>
